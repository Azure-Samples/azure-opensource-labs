GO
PRINT "------ EXECUTING SQL STETUP SCRIPT ------"
PRINT ""
GO
PRINT "------ SETTING UP TRIGGER ------"
PRINT ""
CREATE TRIGGER trg_alter_login ON ALL SERVER
FOR ALTER_LOGIN
AS
    IF ORIGINAL_LOGIN() = '$(SANDBOX_USERNAME)'
    Begin   
        RAISERROR(N'Password change is not allowed here', 10, 1);
        ROLLBACK
    end
GO
PRINT "------ DONE SETTING UP TRIGGER ------"
PRINT ""
GO
PRINT "------ RESTORING $(DEMO_BACKUP_NAME) ------"
PRINT ""
RESTORE DATABASE $(SANDBOX_DB) FROM DISK = '$(DEMO_BACKUP_FILENAME)'
WITH REPLACE, FILE = 1,
    MOVE N'$(DEMO_BACKUP_NAME)' TO N'$(DEMO_BACKUP_NAME_MDF_PATH)',
    MOVE N'$(DEMO_BACKUP_NAME_LOG)' TO  N'$(DEMO_BACKUP_NAME_LOG_PATH)'
GO
USE master
GO
PRINT "------ CONFIGURING $(DEMO_BACKUP_NAME) ------"
PRINT ""
sp_configure 'contained database authentication', 1
GO 
RECONFIGURE;
GO  
ALTER DATABASE $(SANDBOX_DB) SET CONTAINMENT = PARTIAL;
GO
USE $(SANDBOX_DB)
GO
PRINT "------ CREATING SANDBOX USER ------"
PRINT ""
CREATE LOGIN $(SANDBOX_USERNAME) WITH PASSWORD = '$(SANDBOX_PASSWORD)';
CREATE USER $(SANDBOX_USERNAME) FOR LOGIN $(SANDBOX_USERNAME);
GO
EXEC sp_addrolemember N'db_datareader', N'$(SANDBOX_USERNAME)';
EXEC sp_addrolemember N'db_datawriter', N'$(SANDBOX_USERNAME)';
GO
DENY CREATE TABLE, BACKUP DATABASE, BACKUP LOG, CREATE FUNCTION, CREATE PROCEDURE, CREATE RULE TO $(SANDBOX_USERNAME);
GO
USE master
GO
PRINT "------ CREATING SQL PLAYGROUND ------"
PRINT ""
GO
CREATE DATABASE Playground
GO
USE Playground
GO
PRINT "------ CREATING USER, LOGIN & ASSIGNING PERMISSIONS ------"
PRINT ""
CREATE USER $(SANDBOX_USERNAME) FOR LOGIN $(SANDBOX_USERNAME);
EXEC sp_addrolemember N'db_datareader', N'$(SANDBOX_USERNAME)';
EXEC sp_addrolemember N'db_datawriter', N'$(SANDBOX_USERNAME)';
GRANT ALTER, CREATE TABLE TO $(SANDBOX_USERNAME);
DENY DELETE, BACKUP DATABASE, BACKUP LOG, CREATE FUNCTION, CREATE PROCEDURE, CREATE SCHEMA, CREATE RULE TO $(SANDBOX_USERNAME);
GO
PRINT "------ DONE ------"
PRINT ""
GO